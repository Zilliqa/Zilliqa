language: generic

# multiplied by platform
os:
  - osx
  - linux

# multiplied by BUILD_COMMAND
env:
  matrix:
    - BUILD_COMMAND=./build.sh
    - BUILD_COMMAND=./build_lookup.sh

before_install:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      docker pull ubuntu:16.04;
      docker run -d -v $(pwd):/zilliqa -w /zilliqa --name ci ubuntu:16.04 tail -f /dev/null;
    fi

install:
  # note: use option '-t' for 'docker exec' to enable colored output
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      docker exec -t ci /bin/sh -c "
        apt-get -qq update;
        apt-get install -y cmake build-essential pkg-config libssl-dev;
        apt-get install -y libboost-all-dev libleveldb-dev libsnappy-dev;
        apt-get install -y libjsoncpp-dev;
      ";
    else
      brew update;
      brew install pkg-config jsoncpp leveldb;
    fi

script:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      docker exec -t ci /bin/sh -c "$BUILD_COMMAND && ctest";
    else
      $BUILD_COMMAND && ctest;
    fi

# TODO: remove when osx is fully supported
matrix:
  include:
  allow_failures:
    - os: osx

install:
  # libmicrohttpd (the one in ubuntu 12.04 is too old)
  - wget -c http://ftp.gnu.org/gnu/libmicrohttpd/libmicrohttpd-0.9.46.tar.gz
  - (tar zxf libmicrohttpd-0.9.46.tar.gz; cd libmicrohttpd-0.9.46; ./configure; make; sudo make install; cd ..; rm -fr libmicrohttpd-0.9.46)
  - wget -O libjson-rpc-cpp-1.1.0.tar.gz https://github.com/cinemast/libjson-rpc-cpp/archive/v1.1.0.tar.gz
  - (tar xzf libjson-rpc-cpp-1.1.0.tar.gz; cd libjson-rpc-cpp-1.1.0; cmake . && make; sudo make install; sudo ldconfig; cd ..; rm -fr libjson-rpc-cpp-1.1.0)
