name: CI - Development

on:
  workflow_dispatch:
    inputs:
      commitOrTag:
        description: 'Commit or tag'
        required: false
        default: ''
  push:
    branches-ignore:
      - 'release/**'
  pull_request:
    branches:
      - 'master'

jobs:
  push-to-ecr:
    permissions:
      id-token: write
      contents: write
    name: build
    runs-on: docker
    steps:
    - name: Clean environment
      # Prune the Docker resources created over 10 days before the current execution (change the value for a more/less aggressive cleanup).
      shell: bash
      run: |
        docker system df
        docker system prune -a -f --filter "until=336h"
        docker system df
    - name: Set checkout branch
      id: checkout-branch
      run: |
        if [ "${{ inputs.commitOrTag }}" = "" ]; then
          echo "branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          echo "branch=${{ github.event.pull_request.head.ref }}"
        else
          echo "branch=${{ inputs.commitOrTag }}" >> $GITHUB_OUTPUT
          echo "branch=${{ inputs.commitOrTag }}"
        fi
      shell: bash
    - name: 'Checkout scm'
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        ref: ${{ steps.checkout-branch.outputs.branch }}
    - name: Check Pull Request
      run: |
        pull_requests=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/Zilliqa/Zilliqa/pulls?state=open&per_page=100&base=${{ github.event.repository.default_branch }}&head=${{ github.event.repository.owner.login }}:${{ github.ref_name }}" | jq -r ".[].url")

        if [ -n "$pull_requests" ]; then
          echo "There is an open pull request from the current feature branch to the default branch"
        else
          echo "There is no open pull request from the current feature branch to the default branch"
        fi
      shell: bash
    - name: Configure AWS Credentials
      uses: Zilliqa/gh-actions-workflows/actions/configure-aws-credentials@v1
      with:
        role-to-assume: ${{ secrets.ECR_DEPLOYER_ROLE }}
        oidc-role: ${{ secrets.OIDC_ROLE }}
        aws-region: ${{ secrets.AWS_REGION_ZILLIQA }}
    - name: Login to the registry
      uses: docker/login-action@v2
      with:
        registry: ${{ secrets.AWS_ACCOUNT_ID_ZILLIQA }}.dkr.ecr.${{ secrets.AWS_REGION_ZILLIQA }}.amazonaws.com
    - name: Image tag
      id: set-tag
      run: echo "tag=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      shell: bash
    - name: Build Docker images
      run: DOCKER_BUILDKIT=1 docker build -t ${{ secrets.AWS_ACCOUNT_ID_ZILLIQA }}.dkr.ecr.${{ secrets.AWS_REGION_ZILLIQA }}.amazonaws.com/zilliqa:${{ steps.set-tag.outputs.tag }} -f docker/Dockerfile .
      shell: bash
    - name: Push Docker images
      if: github.event_name == 'pull_request' || github.ref_name == 'master'
      run: docker push ${{ secrets.AWS_ACCOUNT_ID_ZILLIQA }}.dkr.ecr.${{ secrets.AWS_REGION_ZILLIQA }}.amazonaws.com/zilliqa:${{ steps.set-tag.outputs.tag }}
      shell: bash

# curl -s -H "Authorization: $GITHUB_TOKEN" "https://api.github.com/repos/Zilliqa/Zilliqa/pulls?state=open"

# curl -s -H "Authorization: $GITHUB_TOKEN" "https://api.github.com/repos/Zilliqa/Zilliqa/pulls?state=open&base=master&head=networking_fix" | jq -r ".[] | select(.base.ref == \"master\" and .number == \"3527\") | .url"


# curl -s -H "Authorization: $GITHUB_TOKEN" "https://api.github.com/repos/Zilliqa/Zilliqa/pulls?state=open&per_page=100&base=master&head=networking_fix" | jq -r ".[].url"